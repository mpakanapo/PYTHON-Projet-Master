from pymongo import MongoClient
from datetime import datetime

# Connexion à MongoDB
client = MongoClient("mongodb://localhost:27017/")
db = client["gestion_marche"]
marche_collection = db["marche"]

# Structure JSON pour un marché
def creer_marche(nom, x, y, ampiladex, ampiladey, marchands=[]):
    marche = {
        "nom": nom,
        "coordonnees": {"x": x, "y": y},
        "dimensions": {"ampiladex": ampiladex, "ampiladey": ampiladey},
        "marchands": marchands
    }
    return marche_collection.insert_one(marche).inserted_id

# Ajouter un marchand
def ajouter_marchand(nom_marche, marchand):
    marche_collection.update_one(
        {"nom": nom_marche},
        {"$push": {"marchands": marchand}}
    )

# Lire tous les marchés
def lire_marches():
    return list(marche_collection.find({}, {"_id": 0}))

# Mettre à jour un marchand dans un marché
def mettre_a_jour_marchand(nom_marche, nom_marchand, new_data):
    marche_collection.update_one(
        {"nom": nom_marche, "marchands.nom": nom_marchand},
        {"$set": {"marchands.$": new_data}}
    )

# Supprimer un marchand d'un marché
def supprimer_marchand(nom_marche, nom_marchand):
    marche_collection.update_one(
        {"nom": nom_marche},
        {"$pull": {"marchands": {"nom": nom_marchand}}}
    )

# Supprimer un marché
def supprimer_marche(nom_marche):
    marche_collection.delete_one({"nom": nom_marche})

# Exemple d'utilisation
if __name__ == "__main__":
    # Création d'un marché
    id_marche = creer_marche("Grand Marché", 10, 20, 100, 50)
    print(f"Marché créé avec ID: {id_marche}")
    
    # Ajout d'un marchand
    marchand = {
        "nom": "Jean",
        "coordonnees": {"x": 5, "y": 10},
        "dimensions": {"ampiladex": 10, "ampiladey": 5},
        "produits": [
            {"nomProduit": "Pomme", "quantiteStock": 50, "prix": 2}
        ],
        "ventes": []
    }
    ajouter_marchand("Grand Marché", marchand)
    print("Marchand ajouté")
    
    # Lecture des marchés
    print(lire_marches())
    
    # Mise à jour du marchand
    marchand_update = marchand.copy()
    marchand_update["produits"].append({"nomProduit": "Banane", "quantiteStock": 30, "prix": 1})
    mettre_a_jour_marchand("Grand Marché", "Jean", marchand_update)
    print("Marchand mis à jour")
    
    # Suppression d'un marchand
    supprimer_marchand("Grand Marché", "Jean")
    print("Marchand supprimé")
    
    # Suppression du marché
    supprimer_marche("Grand Marché")
    print("Marché supprimé")
